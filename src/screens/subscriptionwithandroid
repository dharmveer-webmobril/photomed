import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  SafeAreaView,
  Linking,
  Alert,
  Platform,
} from "react-native";
import React, { useEffect, useState } from "react";
import Loading from "../../components/Loading";
import { useDispatch, useSelector } from "react-redux";
import { useIAP } from "../../configs/IAPContext";
import { goBack } from "../../navigators/NavigationService";
import {
  getAvailablePurchases,
  requestSubscription,
  acknowledgePurchaseAndroid,
  finishTransaction,
} from "react-native-iap";
import { getMySubscriptionDetails } from "../../configs/api";
import { updateSubscription } from "../../redux/slices/authSlice";

const SUBSCRIPTION_SKUS = Platform.select({
  ios: [
    "com.photomedyearlyplan",
    "com.photomedthreemonth",
    "com.photomedonemonth",
  ],
  android: [
    "com.photomedthreemonth",
    "com.photomedyearlyplan",
    "com.photomedonemonth",
  ],
});
const PLAN_PRIORITY = {
  "com.photomedonemonth": 1, // lowest
  "com.photomedthreemonth": 2,
  "com.photomedyearlyplan": 3, // highest
};

export default function SubscriptionManage(params) {
  const token = useSelector((state) => state.auth.user);
  const userId = useSelector((state) => state.auth.userId);
  const dispatch = useDispatch();

  const { subscriptions, fetchSubscriptions, checkSubscriptionStatus } = useIAP();
  const [selectedPlan, setSelectedPlan] = useState("");
  const [isGetSubLoading, setIsGetSubLoading] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [currentSubscription, setCurrentSubscription] = useState(null);

  const from = params?.page || "asd";

  useEffect(() => {
    currentSubscription?.productId &&
      setSelectedPlan(currentSubscription.productId);
  }, [currentSubscription]);

  useEffect(() => {
    const fetchSubscription = async () => {
      setIsGetSubLoading(true);
      const data =
        token && userId && (await getMySubscriptionDetails(token, userId));
      if (data) {
        setCurrentSubscription(data);
      }
      setIsGetSubLoading(false);
    };

    fetchSubscription();
  }, [token, userId]);

  useEffect(() => {
    getMySubscriptionDetails();
  }, []);

  useEffect(() => {
    const loadSubscriptions = async () => {
      if (!token) {
        Alert.alert(
          "Error",
          "Authentication token missing. Please log in again."
        );
        return;
      }
      setIsLoading(true);
      try {
        await fetchSubscriptions();
      } catch (error) {
        console.error("Error loading subscriptions:", error);
        Alert.alert("Error", "Failed to load subscriptions. Please try again.");
      } finally {
        setIsLoading(false);
      }
    };
    loadSubscriptions();
  }, [token, userId, fetchSubscriptions]);

  const finishTransaction1 = async (purchase) => {
    try {
      await finishTransaction({ purchase, isConsumable: false });
    } catch (err) {
      console.warn("Finish transaction error:", err);
    }
  };

  const acknowledgePurchaseAndroid1 = async (purchase) => {
    try {
      if (purchase.purchaseToken) {
        await acknowledgePurchaseAndroid({
          token: purchase.purchaseToken,
          developerPayload: purchase.developerPayloadAndroid || "",
        });
        await finishTransaction1(purchase);
      } else {
        console.warn("No purchase token found for Android purchase");
      }
    } catch (err) {
      console.warn("Acknowledge purchase error:", err);
      throw err; // Re-throw to handle in caller
    }
  };

  const handlePurchase = async () => {
    try {
      setIsLoading(true);

      let res = await getMySubscriptionDetails(token, userId);
      console.log("getMySubscriptionDetails res", res);

      if (res && res?.productId && res?.isExpired === false) {
        const currentPlanPriority = PLAN_PRIORITY[res.productId];
        const selectedPlanPriority = PLAN_PRIORITY[selectedPlan];

        if (selectedPlanPriority < currentPlanPriority) {
          Alert.alert(
            "Alert",
            "You already have a higher plan. You can only purchase a lower plan after your current subscription expires or is cancelled.\n\n👉 To manage your subscription, please go to your App Store/Google Play account."
          );
          return;
        }
      }
      if (!selectedPlan) {
        Alert.alert("Error", "Please select a plan.");
        return;
      }
      if (!token) {
        Alert.alert(
          "Error",
          "Authentication token missing. Please log in again."
        );
        return;
      }

      // Start purchase
      const purchase = await requestSubscription({ sku: selectedPlan });
      console.log("purchasepurchasepurchase", purchase);

      if (purchase?.transactionReceipt || purchase?.purchaseToken) {
        // Verify with backend
        const response = await fetch(
          "https://photomedpro.com:10049/api/verify-inapp-receipt",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              receipt: purchase.transactionReceipt || purchase.purchaseToken, // Use purchaseToken for Android
              platform: Platform.OS,
              transactionId: purchase.transactionId,
              userId,
            }),
          }
        );

        const responseData = await response.json();
        console.log("verify-inapp-receipt response:", responseData);

        if (response.ok && responseData.success) {
          // Acknowledge purchase for Android
          if (Platform.OS === "android") {
            await acknowledgePurchaseAndroid1(purchase);
          } else {
            await finishTransaction1(purchase);
          }

          let expData = {
            expirationDate: responseData?.expirationDate,
            hasSubscription: true,
            isActive: responseData?.isActive,
            isExpired: responseData?.isExpired,
            productId: responseData?.productId || purchase.productId,
            success: responseData?.success,
            transactionId:
              responseData?.transactionId || purchase.transactionId,
          };

          console.log("expData --------", expData);
          setCurrentSubscription(expData);
          dispatch(updateSubscription(expData));
          if (from === "profile") {
            goBack();
          }
          Alert.alert("Success", "Purchase verified and activated!");
        } else {
          Alert.alert("Error", "Purchase verification failed.");
        }
      } else {
        Alert.alert("Error", "Purchase failed. No receipt or token received.");
      }
    } catch (error) {
      console.error("Purchase failed:", error, error?.code);
      // Handle Android-specific billing errors
      if (Platform.OS === "android") {
        switch (error.code) {
          case "E_USER_CANCELLED":
            Alert.alert("Info", "Purchase was cancelled.");
            break;
          case "E_ITEM_ALREADY_OWNED":
            Alert.alert(
              "Info",
              "You already own this subscription. Try restoring purchases."
            );
            break;
          case "E_SERVICE_ERROR":
            Alert.alert(
              "Error",
              "Google Play Billing service is unavailable. Please try again later."
            );
            break;
          default:
            Alert.alert(
              "Error",
              `Failed to complete purchase: ${error.message || "Unknown error"}`
            );
        }
      } else {
        Alert.alert("Error", "Failed to complete purchase. Please try again.");
      }
    } finally {
      setIsLoading(false);
    }
  };

  const restorePurchases = async () => {
    if (!token) {
      Alert.alert(
        "Error",
        "Authentication token missing. Please log in again."
      );
      return;
    }
    setIsLoading(true);
    try {
      const purchases = await getAvailablePurchases();
      if (purchases.length > 0) {
        const latest = purchases.sort(
          (a, b) => new Date(b.transactionDate) - new Date(a.transactionDate)
        )[0];
        const response = await fetch(
          "https://photomedpro.com:10049/api/verify-inapp-receipt",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              receipt: latest.transactionReceipt || latest.purchaseToken, // Use purchaseToken for Android
              platform: Platform.OS,
              userId,
            }),
          }
        );
        const responseData = await response.json();

        console.log("restorePurchases response:", responseData);
        if (response.ok) {
          if (responseData) {
            let expData = {
              expirationDate: responseData?.expirationDate,
              hasSubscription: true,
              isActive: responseData?.isActive,
              isExpired: responseData?.isExpired,
              productId: responseData?.productId || latest.productId,
              success: responseData?.success,
              transactionId:
                responseData?.transactionId || latest.transactionId,
            };

            console.log("expData restore --------", expData);
            setCurrentSubscription(expData);
            dispatch(updateSubscription(expData));

            // Acknowledge Android purchase if not already acknowledged
            if (Platform.OS === "android" && latest.purchaseToken) {
              await acknowledgePurchaseAndroid1(latest);
            }
          }
          Alert.alert("Success", "Purchases restored successfully.");
        } else {
          console.error("Restore failed:", responseData);
          Alert.alert("Error", "Failed to restore purchases.");
        }
      } else {
        Alert.alert("Info", "No purchases found to restore.");
      }
    } catch (error) {
      console.error("Restore failed:", error);
      Alert.alert("Error", "Failed to restore purchases. Please try again.");
    } finally {
      setIsLoading(false);
    }
  };

  const handleCancelPlan = async () => {
    try {
      Alert.alert(
        "Cancel Subscription",
        Platform.OS === "ios"
          ? "To cancel your subscription, please open the Settings app on your iPhone, go to your Apple ID → Subscriptions, and manage it there."
          : "To cancel your subscription, please open the Google Play Store app, tap on your profile → Payments & subscriptions → Subscriptions, and manage it there.",
        [
          {
            text: "Open Store",
            onPress: async () => {
              const url =
                Platform.OS === "ios"
                  ? "itms-apps://apps.apple.com/account/subscriptions"
                  : "https://play.google.com/store/account/subscriptions";
              try {
                await Linking.openURL(url);
              } catch (err) {
                console.error("Failed to open URL:", err);
                Alert.alert("Error", "Failed to open subscription management.");
              }
            },
          },
          { text: "Cancel", style: "cancel" },
        ]
      );
    } catch (error) {
      console.error("Failed to open subscription management:", error);
      Alert.alert("Error", "Failed to open subscription management.");
    }
  };

  const CustomRadioButton = ({ selected, onPress }) => (
    <TouchableOpacity onPress={onPress} style={styles.radioOuter}>
      {selected && <View style={styles.radioInner} />}
    </TouchableOpacity>
  );

  return (
    <SafeAreaView style={styles.safeArea}>
      <Loading visible={isLoading || isGetSubLoading} />
      <View style={styles.container}>
        <View style={styles.header}>
          <TouchableOpacity
            onPress={() => {
              from === "profile" && goBack();
            }}
          >
            {from === "profile" && <Text style={styles.iconText}>←</Text>}
          </TouchableOpacity>
          <Text style={styles.headerTitle}>Manage Subscription Plan</Text>
          <View />
        </View>

        <ScrollView contentContainerStyle={styles.scrollContent}>
          {currentSubscription?.hasSubscription &&
            currentSubscription?.isActive === false && (
              <Text style={{ color: "red", marginBottom: 10 }}>
                Your current subscription has expired. Please renew to continue
                enjoying premium features.
              </Text>
            )}

          {subscriptions?.length > 0 &&
            subscriptions.map((plan) => {
              const isSelected = selectedPlan === plan.productId;
              return (
                <TouchableOpacity
                  key={plan.productId}
                  onPress={() => setSelectedPlan(plan.productId)}
                  style={[styles.planCard, isSelected && styles.selectedCard]}
                >
                  <View style={styles.cardHeader}>
                    {plan.productId === "com.photomedthreemonth" && (
                      <Text style={styles.planTitle}>3-Month Premium Plan</Text>
                    )}
                    {plan.productId === "com.photomedyearlyplan" && (
                      <Text style={styles.planTitle}>
                        Annual Pro Subscription
                      </Text>
                    )}
                    {plan.productId === "com.photomedonemonth" && (
                      <Text style={styles.planTitle}>Monthly Access Plan</Text>
                    )}
                    <Text style={styles.planPrice}>{plan.localizedPrice}</Text>
                  </View>
                  {plan.productId === "com.photomedthreemonth" && (
                    <Text style={styles.planText}>
                      • Enjoy full access to all features for 3 months
                    </Text>
                  )}
                  {plan.productId === "com.photomedyearlyplan" && (
                    <Text style={styles.planText}>
                      • Full app access for a year at a great value
                    </Text>
                  )}
                  {plan.productId === "com.photomedonemonth" && (
                    <Text style={styles.planText}>
                      • Access to all features for 1 month
                    </Text>
                  )}
                  <Text style={styles.planText}>
                    • Everything in Standard Plan
                  </Text>
                  <Text style={styles.planText}>
                    • Exclusive Content & Tips
                  </Text>
                  {currentSubscription?.productId === plan.productId && (
                    <Text style={styles.planText}>
                      Active until{" "}
                      {new Date(
                        currentSubscription.expirationDate
                      ).toLocaleDateString()}
                    </Text>
                  )}
                  <View style={styles.radioWrapper}>
                    <CustomRadioButton
                      selected={isSelected}
                      onPress={() => setSelectedPlan(plan.productId)}
                    />
                  </View>
                </TouchableOpacity>
              );
            })}

          {subscriptions?.length > 0 && (
            <>
              <TouchableOpacity
                style={styles.restoreBtn}
                onPress={handlePurchase}
              >
                <Text style={styles.restoreText}>
                  {selectedPlan === currentSubscription?.productId
                    ? "Upgrade Plan"
                    : "Subscribe"}
                </Text>
              </TouchableOpacity>
              {selectedPlan === currentSubscription?.productId &&
                currentSubscription?.isExpired === false && (
                  <TouchableOpacity
                    style={styles.restoreBtn}
                    onPress={handleCancelPlan}
                  >
                    <Text style={styles.restoreText}>Cancel Plan</Text>
                  </TouchableOpacity>
                )}
              <TouchableOpacity
                style={styles.restoreBtn}
                onPress={restorePurchases}
              >
                <Text style={styles.restoreText}>Restore Purchases</Text>
              </TouchableOpacity>
            </>
          )}
          <Text style={{ color: "#000", marginTop: 10 }}>
            Note:- If your payment was deducted but the plan was not activated,
            click the Restore Button to restore your plan.
          </Text>

          <Text
            style={{
              textAlign: "center",
              marginHorizontal: 20,
              color: "#000",
              marginTop: 30,
            }}
          >
            Payment will be charged to your {Platform.OS === "ios" ? "iTunes Account" : "Google Play Account"} at confirmation of
            purchase. Subscription automatically renews unless auto-renew is
            turned off at least 24-hours before the end of the current period.
            Account will be charged for renewal within 24-hours prior to the end
            of the current period, and identify the cost of the renewal.
            Subscriptions may be managed by the user and auto-renewal may be
            turned off by going to the user's Account Settings after purchase.
            No cancellation of the current subscription is allowed during active
            subscription period. Any unused portion of a free trial period, if
            offered, will be forfeited when the user purchases a subscription to
            that publication, where applicable
          </Text>

          <View
            style={{
              flexDirection: "row",
              marginHorizontal: 20,
              marginTop: 20,
              marginBottom: 30,
              justifyContent: "center",
            }}
          >
            <Text
              onPress={() =>
                navigate("Terms and Condition", {
                  slug: "terms-and-conditions",
                  screenName: "Terms and Conditions",
                })
              }
              style={{
                color: "#32327C",
                marginRight: 10,
                textDecorationLine: "underline",
              }}
            >
              Terms of Service
            </Text>
            <Text
              onPress={() =>
                navigate("Terms and Condition", {
                  slug: "privacy-policy",
                  screenName: "Privacy Policy",
                })
              }
              style={{
                color: "#32327C",
                marginLeft: 10,
                textDecorationLine: "underline",
              }}
            >
              Privacy Policy
            </Text>
          </View>
        </ScrollView>
      </View>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  safeArea: {
    flex: 1,
    backgroundColor: "#fff",
  },
  container: {
    flex: 1,
    paddingHorizontal: 16,
  },
  header: {
    flexDirection: "row",
    alignItems: "center",
    justifyContent: "space-between",
    paddingVertical: 15,
  },
  iconText: {
    fontSize: 20,
    fontWeight: "600",
    color: "#000",
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: "600",
  },
  scrollContent: {
    paddingVertical: 10,
    alignItems: "center",
  },
  planCard: {
    backgroundColor: "#fff",
    width: "96%",
    borderRadius: 16,
    padding: 16,
    marginBottom: 20,
    marginHorizontal: 10,
    elevation: 3,
    shadowColor: "#000",
    shadowOpacity: 0.1,
    shadowRadius: 4,
    shadowOffset: { width: 0, height: 2 },
    position: "relative",
  },
  selectedCard: {
    backgroundColor: "#e0e0f3",
  },
  cardHeader: {
    flexDirection: "row",
    justifyContent: "space-between",
    marginBottom: 12,
  },
  planTitle: {
    fontSize: 16,
    fontWeight: "600",
  },
  planPrice: {
    fontSize: 16,
    fontWeight: "600",
  },
  planText: {
    fontSize: 14,
    color: "#555",
    marginBottom: 4,
  },
  radioWrapper: {
    position: "absolute",
    right: 16,
    bottom: 16,
  },
  radioOuter: {
    height: 20,
    width: 20,
    borderRadius: 10,
    borderWidth: 2,
    borderColor: "#32327C",
    alignItems: "center",
    justifyContent: "center",
  },
  radioInner: {
    height: 10,
    width: 10,
    borderRadius: 5,
    backgroundColor: "#32327C",
  },
  restoreBtn: {
    flexDirection: "row",
    justifyContent: "center",
    alignItems: "center",
    marginTop: 14,
    paddingVertical: 12,
    borderWidth: 1.5,
    borderColor: "#32327C",
    borderRadius: 10,
    width: "96%",
  },
  restoreText: {
    color: "#32327C",
    fontSize: 16,
    marginLeft: 8,
    fontWeight: "600",
  },
});